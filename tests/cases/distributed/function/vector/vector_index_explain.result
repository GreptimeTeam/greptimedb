-- Distributed vector explain coverage for partitioned tables.
DROP TABLE IF EXISTS vectors_explain_dist;

Affected Rows: 0

CREATE TABLE vectors_explain_dist (
    ts TIMESTAMP TIME INDEX,
    vec_id INT PRIMARY KEY,
    part_tag STRING,
    embedding VECTOR(2) NOT NULL VECTOR INDEX WITH (metric = 'l2sq')
) PARTITION ON COLUMNS (part_tag) (
    part_tag < 'm',
    part_tag >= 'm'
);

Affected Rows: 0

INSERT INTO vectors_explain_dist VALUES
    ('2024-01-02T00:00:00Z', 1, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:01Z', 3, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:02Z', 5, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:03Z', 7, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:04Z', 9, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:05Z', 11, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:06Z', 13, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:07Z', 15, 'a', '[0.0, 0.0]'),
    ('2024-01-02T00:00:08Z', 101, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:09Z', 103, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:10Z', 105, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:11Z', 107, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:12Z', 109, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:13Z', 111, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:14Z', 113, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:15Z', 115, 'z', '[0.0, 0.0]'),
    ('2024-01-02T00:00:16Z', 102, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:17Z', 104, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:18Z', 106, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:19Z', 108, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:20Z', 110, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:21Z', 112, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:22Z', 114, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:23Z', 116, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:24Z', 118, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:25Z', 120, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:26Z', 122, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:27Z', 124, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:28Z', 126, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:29Z', 128, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:30Z', 130, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:31Z', 132, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:32Z', 134, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:33Z', 136, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:34Z', 138, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:35Z', 140, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:36Z', 142, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:37Z', 144, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:38Z', 146, 'z', '[1.0, 0.0]'),
    ('2024-01-02T00:00:39Z', 148, 'z', '[1.0, 0.0]');

Affected Rows: 40

ADMIN FLUSH_TABLE('vectors_explain_dist');

+-------------------------------------------+
| ADMIN FLUSH_TABLE('vectors_explain_dist') |
+-------------------------------------------+
| 0                                         |
+-------------------------------------------+

SELECT
  vec_id,
  part_tag,
  vec_l2sq_distance(embedding, '[0.0, 0.0]') AS d
FROM vectors_explain_dist
WHERE part_tag IN ('a', 'z')
ORDER BY d ASC, vec_id ASC
LIMIT 2 OFFSET 20;

+--------+----------+-----+
| vec_id | part_tag | d   |
+--------+----------+-----+
| 110    | z        | 1.0 |
| 112    | z        | 1.0 |
+--------+----------+-----+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (RoundRobinBatch.*) REDACTED
-- SQLNESS REPLACE (Hash.*) REDACTED
-- SQLNESS REPLACE (peers.*) REDACTED
EXPLAIN
SELECT
  vec_id,
  part_tag,
  vec_l2sq_distance(embedding, '[0.0, 0.0]') AS d
FROM vectors_explain_dist
WHERE part_tag IN ('a', 'z')
ORDER BY d ASC, vec_id ASC
LIMIT 2 OFFSET 20;

+-+-+
| plan_type_| plan_|
+-+-+
| logical_plan_| AdaptiveVectorTopK: d ASC NULLS LAST, vectors_explain_dist.vec_id ASC NULLS LAST, fetch=2, skip=20_|
|_|_MergeScan [is_placeholder=false, remote_input=[_|
|_| Sort: d ASC NULLS LAST, vectors_explain_dist.vec_id ASC NULLS LAST_|
|_|_Projection: vectors_explain_dist.vec_id, vectors_explain_dist.part_tag, vec_l2sq_distance(vectors_explain_dist.embedding, Utf8("[0.0, 0.0]")) AS d |
|_|_Filter: vectors_explain_dist.part_tag = Utf8("a") OR vectors_explain_dist.part_tag = Utf8("z")_|
|_|_TableScan: vectors_explain_dist_|
|_| ]]_|
| physical_plan | AdaptiveVectorTopKExec_|
|_|_CooperativeExec_|
|_|_MergeScanExec: REDACTED
|_|_|
+-+-+

-- SQLNESS REPLACE ("metrics_per_partition":\s*.*metrics=) "metrics_per_partition": REDACTED metrics=
-- SQLNESS REPLACE (RoundRobinBatch.*) REDACTED
-- SQLNESS REPLACE Hash\(\[vec_id@0\],.* Hash([vec_id@0],REDACTED
-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE "(file_id|time_range_start|time_range_end)":"[^"]+" "$1":"REDACTED"
-- SQLNESS REPLACE ("[a-z_]+":"[0-9\.]+(ns|us|µs|ms|s)") "DURATION": REDACTED
-- SQLNESS REPLACE "(size|flat_format)":\s*(\d+|true|false) "$1":REDACTED
-- SQLNESS REPLACE ,\s*filter=.*?metrics=  metrics=
-- SQLNESS REPLACE Total\s+rows:\s+\d+ Total rows: REDACTED
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE VERBOSE
SELECT
  vec_id,
  part_tag,
  vec_l2sq_distance(embedding, '[0.0, 0.0]') AS d
FROM vectors_explain_dist
WHERE part_tag IN ('a', 'z')
ORDER BY d ASC, vec_id ASC
LIMIT 2 OFFSET 20;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_AdaptiveVectorTopKExec metrics=[vector_index_desired_rows: 22, vector_index_kth_distance_micros: 1000000, vector_index_last_k: 44, vector_index_requested_k: 176, vector_index_result_len: 2, vector_index_retry_rounds: 1, vector_index_returned_k: 40, ] |
|_|_|_CooperativeExec metrics=[]_|
|_|_|_MergeScanExec: REDACTED
|_|_|_|
|_|_| Total rows: REDACTED_|
+-+-+-+

SELECT
  vec_id,
  part_tag,
  vec_l2sq_distance(embedding, '[0.0, 0.0]') AS d
FROM vectors_explain_dist
WHERE part_tag IN ('a', 'z')
ORDER BY d ASC, vec_id ASC
LIMIT 2 OFFSET 30;

+--------+----------+-----+
| vec_id | part_tag | d   |
+--------+----------+-----+
| 130    | z        | 1.0 |
| 132    | z        | 1.0 |
+--------+----------+-----+

-- SQLNESS REPLACE ("metrics_per_partition":\s*.*metrics=) "metrics_per_partition": REDACTED metrics=
-- SQLNESS REPLACE (RoundRobinBatch.*) REDACTED
-- SQLNESS REPLACE Hash\(\[vec_id@0\],.* Hash([vec_id@0],REDACTED
-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE "(file_id|time_range_start|time_range_end)":"[^"]+" "$1":"REDACTED"
-- SQLNESS REPLACE ("[a-z_]+":"[0-9\.]+(ns|us|µs|ms|s)") "DURATION": REDACTED
-- SQLNESS REPLACE "(size|flat_format)":\s*(\d+|true|false) "$1":REDACTED
-- SQLNESS REPLACE ,\s*filter=.*?metrics=  metrics=
-- SQLNESS REPLACE Total\s+rows:\s+\d+ Total rows: REDACTED
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE VERBOSE
SELECT
  vec_id,
  part_tag,
  vec_l2sq_distance(embedding, '[0.0, 0.0]') AS d
FROM vectors_explain_dist
WHERE part_tag IN ('a', 'z')
ORDER BY d ASC, vec_id ASC
LIMIT 2 OFFSET 30;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_AdaptiveVectorTopKExec metrics=[vector_index_desired_rows: 32, vector_index_kth_distance_micros: 1000000, vector_index_last_k: 64, vector_index_requested_k: 256, vector_index_result_len: 2, vector_index_retry_rounds: 1, vector_index_returned_k: 40, ] |
|_|_|_CooperativeExec metrics=[]_|
|_|_|_MergeScanExec: REDACTED
|_|_|_|
|_|_| Total rows: REDACTED_|
+-+-+-+

DROP TABLE vectors_explain_dist;

Affected Rows: 0

