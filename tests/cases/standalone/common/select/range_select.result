CREATE TABLE host (
  ts timestamp(3) time index,
  host STRING PRIMARY KEY,
  val BIGINT,
);

Affected Rows: 0

INSERT INTO TABLE host VALUES
    (0,     'host1', 0),
    (5000,  'host1', null),
    (10000, 'host1', 1),
    (15000, 'host1', null),
    (20000, 'host1', 2),
    (0,     'host2', 3),
    (5000,  'host2', null),
    (10000, 'host2', 4),
    (15000, 'host2', null),
    (20000, 'host2', 5);

Affected Rows: 10

-- Test Fill
SELECT ts, host, min(val) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+----------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL |
+---------------------+-------+----------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                |
| 1970-01-01T00:00:05 | host1 |                                  |
| 1970-01-01T00:00:10 | host1 | 1                                |
| 1970-01-01T00:00:15 | host1 |                                  |
| 1970-01-01T00:00:20 | host1 | 2                                |
| 1970-01-01T00:00:00 | host2 | 3                                |
| 1970-01-01T00:00:05 | host2 |                                  |
| 1970-01-01T00:00:10 | host2 | 4                                |
| 1970-01-01T00:00:15 | host2 |                                  |
| 1970-01-01T00:00:20 | host2 | 5                                |
+---------------------+-------+----------------------------------+

SELECT ts, host, min(val) RANGE '5s' FROM host ALIGN '5s' FILL NULL ORDER BY host, ts;

+---------------------+-------+----------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL |
+---------------------+-------+----------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                |
| 1970-01-01T00:00:05 | host1 |                                  |
| 1970-01-01T00:00:10 | host1 | 1                                |
| 1970-01-01T00:00:15 | host1 |                                  |
| 1970-01-01T00:00:20 | host1 | 2                                |
| 1970-01-01T00:00:00 | host2 | 3                                |
| 1970-01-01T00:00:05 | host2 |                                  |
| 1970-01-01T00:00:10 | host2 | 4                                |
| 1970-01-01T00:00:15 | host2 |                                  |
| 1970-01-01T00:00:20 | host2 | 5                                |
+---------------------+-------+----------------------------------+

SELECT ts, host, min(val) RANGE '5s', min(val) RANGE '5s' FILL 6 FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+----------------------------------+-------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL | MIN(host.val) RANGE 5s FILL 6 |
+---------------------+-------+----------------------------------+-------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                | 0                             |
| 1970-01-01T00:00:05 | host1 |                                  | 6                             |
| 1970-01-01T00:00:10 | host1 | 1                                | 1                             |
| 1970-01-01T00:00:15 | host1 |                                  | 6                             |
| 1970-01-01T00:00:20 | host1 | 2                                | 2                             |
| 1970-01-01T00:00:00 | host2 | 3                                | 3                             |
| 1970-01-01T00:00:05 | host2 |                                  | 6                             |
| 1970-01-01T00:00:10 | host2 | 4                                | 4                             |
| 1970-01-01T00:00:15 | host2 |                                  | 6                             |
| 1970-01-01T00:00:20 | host2 | 5                                | 5                             |
+---------------------+-------+----------------------------------+-------------------------------+

SELECT ts, host, min(val) RANGE '5s', min(val) RANGE '5s' FILL PREV FROM host ALIGN '5s'ORDER BY host, ts;

+---------------------+-------+----------------------------------+----------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL | MIN(host.val) RANGE 5s FILL PREV |
+---------------------+-------+----------------------------------+----------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                | 0                                |
| 1970-01-01T00:00:05 | host1 |                                  | 0                                |
| 1970-01-01T00:00:10 | host1 | 1                                | 1                                |
| 1970-01-01T00:00:15 | host1 |                                  | 1                                |
| 1970-01-01T00:00:20 | host1 | 2                                | 2                                |
| 1970-01-01T00:00:00 | host2 | 3                                | 3                                |
| 1970-01-01T00:00:05 | host2 |                                  | 3                                |
| 1970-01-01T00:00:10 | host2 | 4                                | 4                                |
| 1970-01-01T00:00:15 | host2 |                                  | 4                                |
| 1970-01-01T00:00:20 | host2 | 5                                | 5                                |
+---------------------+-------+----------------------------------+----------------------------------+

SELECT ts, host, min(val) RANGE '5s', min(val) RANGE '5s' FILL LINEAR FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+----------------------------------+------------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL | MIN(host.val) RANGE 5s FILL LINEAR |
+---------------------+-------+----------------------------------+------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                | 0.0                                |
| 1970-01-01T00:00:05 | host1 |                                  | 0.5                                |
| 1970-01-01T00:00:10 | host1 | 1                                | 1.0                                |
| 1970-01-01T00:00:15 | host1 |                                  | 1.5                                |
| 1970-01-01T00:00:20 | host1 | 2                                | 2.0                                |
| 1970-01-01T00:00:00 | host2 | 3                                | 3.0                                |
| 1970-01-01T00:00:05 | host2 |                                  | 3.5                                |
| 1970-01-01T00:00:10 | host2 | 4                                | 4.0                                |
| 1970-01-01T00:00:15 | host2 |                                  | 4.5                                |
| 1970-01-01T00:00:20 | host2 | 5                                | 5.0                                |
+---------------------+-------+----------------------------------+------------------------------------+

-- Test range query in nest sql
SELECT ts, host, foo FROM (SELECT ts, host, min(val) RANGE '5s' AS foo FROM host ALIGN '5s') WHERE host = 'host1' ORDER BY host, ts;

+---------------------+-------+-----+
| ts                  | host  | foo |
+---------------------+-------+-----+
| 1970-01-01T00:00:00 | host1 | 0   |
| 1970-01-01T00:00:05 | host1 |     |
| 1970-01-01T00:00:10 | host1 | 1   |
| 1970-01-01T00:00:15 | host1 |     |
| 1970-01-01T00:00:20 | host1 | 2   |
+---------------------+-------+-----+

SELECT ts, b, min(c) RANGE '5s' FROM (SELECT ts, host AS b, val AS c FROM host WHERE host = 'host1') ALIGN '5s' BY (b) ORDER BY b, ts;

+---------------------+-------+---------------------------+
| ts                  | b     | MIN(c) RANGE 5s FILL NULL |
+---------------------+-------+---------------------------+
| 1970-01-01T00:00:00 | host1 | 0                         |
| 1970-01-01T00:00:05 | host1 |                           |
| 1970-01-01T00:00:10 | host1 | 1                         |
| 1970-01-01T00:00:15 | host1 |                           |
| 1970-01-01T00:00:20 | host1 | 2                         |
+---------------------+-------+---------------------------+

-- Test range expr calculate
SELECT ts, host, covar(val, val) RANGE '20s' FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-------+---------------------------------------------------+
| ts                  | host  | COVARIANCE(host.val,host.val) RANGE 20s FILL NULL |
+---------------------+-------+---------------------------------------------------+
| 1970-01-01T00:00:00 | host1 |                                                   |
| 1970-01-01T00:00:10 | host1 | 0.5                                               |
| 1970-01-01T00:00:20 | host1 | 0.5                                               |
| 1970-01-01T00:00:30 | host1 |                                                   |
| 1970-01-01T00:00:00 | host2 |                                                   |
| 1970-01-01T00:00:10 | host2 | 0.5                                               |
| 1970-01-01T00:00:20 | host2 | 0.5                                               |
| 1970-01-01T00:00:30 | host2 |                                                   |
+---------------------+-------+---------------------------------------------------+

SELECT ts, host, 2 * min(val) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+---------------------------------------------+
| ts                  | host  | Int64(2) * MIN(host.val) RANGE 5s FILL NULL |
+---------------------+-------+---------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                           |
| 1970-01-01T00:00:05 | host1 |                                             |
| 1970-01-01T00:00:10 | host1 | 2                                           |
| 1970-01-01T00:00:15 | host1 |                                             |
| 1970-01-01T00:00:20 | host1 | 4                                           |
| 1970-01-01T00:00:00 | host2 | 6                                           |
| 1970-01-01T00:00:05 | host2 |                                             |
| 1970-01-01T00:00:10 | host2 | 8                                           |
| 1970-01-01T00:00:15 | host2 |                                             |
| 1970-01-01T00:00:20 | host2 | 10                                          |
+---------------------+-------+---------------------------------------------+

SELECT ts, host, min(val * 2) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+---------------------------------------------+
| ts                  | host  | MIN(host.val * Int64(2)) RANGE 5s FILL NULL |
+---------------------+-------+---------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                           |
| 1970-01-01T00:00:05 | host1 |                                             |
| 1970-01-01T00:00:10 | host1 | 2                                           |
| 1970-01-01T00:00:15 | host1 |                                             |
| 1970-01-01T00:00:20 | host1 | 4                                           |
| 1970-01-01T00:00:00 | host2 | 6                                           |
| 1970-01-01T00:00:05 | host2 |                                             |
| 1970-01-01T00:00:10 | host2 | 8                                           |
| 1970-01-01T00:00:15 | host2 |                                             |
| 1970-01-01T00:00:20 | host2 | 10                                          |
+---------------------+-------+---------------------------------------------+

SELECT ts, host, min(CAST(val as Float64)) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+----------------------------------+
| ts                  | host  | MIN(host.val) RANGE 5s FILL NULL |
+---------------------+-------+----------------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                              |
| 1970-01-01T00:00:05 | host1 |                                  |
| 1970-01-01T00:00:10 | host1 | 1.0                              |
| 1970-01-01T00:00:15 | host1 |                                  |
| 1970-01-01T00:00:20 | host1 | 2.0                              |
| 1970-01-01T00:00:00 | host2 | 3.0                              |
| 1970-01-01T00:00:05 | host2 |                                  |
| 1970-01-01T00:00:10 | host2 | 4.0                              |
| 1970-01-01T00:00:15 | host2 |                                  |
| 1970-01-01T00:00:20 | host2 | 5.0                              |
+---------------------+-------+----------------------------------+

SELECT ts, host, min(floor(CAST(val as Float64))) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+-----------------------------------------+
| ts                  | host  | MIN(floor(host.val)) RANGE 5s FILL NULL |
+---------------------+-------+-----------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                                     |
| 1970-01-01T00:00:05 | host1 |                                         |
| 1970-01-01T00:00:10 | host1 | 1.0                                     |
| 1970-01-01T00:00:15 | host1 |                                         |
| 1970-01-01T00:00:20 | host1 | 2.0                                     |
| 1970-01-01T00:00:00 | host2 | 3.0                                     |
| 1970-01-01T00:00:05 | host2 |                                         |
| 1970-01-01T00:00:10 | host2 | 4.0                                     |
| 1970-01-01T00:00:15 | host2 |                                         |
| 1970-01-01T00:00:20 | host2 | 5.0                                     |
+---------------------+-------+-----------------------------------------+

SELECT ts, host, floor(min(val) RANGE '5s') FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+-----------------------------------------+
| ts                  | host  | floor(MIN(host.val) RANGE 5s FILL NULL) |
+---------------------+-------+-----------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                                     |
| 1970-01-01T00:00:05 | host1 |                                         |
| 1970-01-01T00:00:10 | host1 | 1.0                                     |
| 1970-01-01T00:00:15 | host1 |                                         |
| 1970-01-01T00:00:20 | host1 | 2.0                                     |
| 1970-01-01T00:00:00 | host2 | 3.0                                     |
| 1970-01-01T00:00:05 | host2 |                                         |
| 1970-01-01T00:00:10 | host2 | 4.0                                     |
| 1970-01-01T00:00:15 | host2 |                                         |
| 1970-01-01T00:00:20 | host2 | 5.0                                     |
+---------------------+-------+-----------------------------------------+

-- Test complex range expr calculate
SELECT ts, host, (min(val) + max(val)) RANGE '20s' + 1.0 FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-------+------------------------------------------------------------------------------------+
| ts                  | host  | MIN(host.val) RANGE 20s FILL NULL + MAX(host.val) RANGE 20s FILL NULL + Float64(1) |
+---------------------+-------+------------------------------------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1.0                                                                                |
| 1970-01-01T00:00:10 | host1 | 2.0                                                                                |
| 1970-01-01T00:00:20 | host1 | 4.0                                                                                |
| 1970-01-01T00:00:30 | host1 | 5.0                                                                                |
| 1970-01-01T00:00:00 | host2 | 7.0                                                                                |
| 1970-01-01T00:00:10 | host2 | 8.0                                                                                |
| 1970-01-01T00:00:20 | host2 | 10.0                                                                               |
| 1970-01-01T00:00:30 | host2 | 11.0                                                                               |
+---------------------+-------+------------------------------------------------------------------------------------+

SELECT ts, host, covar(ceil(CAST(val as Float64)), floor(CAST(val as Float64))) RANGE '20s' FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-------+----------------------------------------------------------------+
| ts                  | host  | COVARIANCE(ceil(host.val),floor(host.val)) RANGE 20s FILL NULL |
+---------------------+-------+----------------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 |                                                                |
| 1970-01-01T00:00:10 | host1 | 0.5                                                            |
| 1970-01-01T00:00:20 | host1 | 0.5                                                            |
| 1970-01-01T00:00:30 | host1 |                                                                |
| 1970-01-01T00:00:00 | host2 |                                                                |
| 1970-01-01T00:00:10 | host2 | 0.5                                                            |
| 1970-01-01T00:00:20 | host2 | 0.5                                                            |
| 1970-01-01T00:00:30 | host2 |                                                                |
+---------------------+-------+----------------------------------------------------------------+

SELECT ts, host, floor(cos(ceil(sin(min(val) RANGE '5s')))) FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+---------------------------------------------------------+
| ts                  | host  | floor(cos(ceil(sin(MIN(host.val) RANGE 5s FILL NULL)))) |
+---------------------+-------+---------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1.0                                                     |
| 1970-01-01T00:00:05 | host1 |                                                         |
| 1970-01-01T00:00:10 | host1 | 0.0                                                     |
| 1970-01-01T00:00:15 | host1 |                                                         |
| 1970-01-01T00:00:20 | host1 | 0.0                                                     |
| 1970-01-01T00:00:00 | host2 | 0.0                                                     |
| 1970-01-01T00:00:05 | host2 |                                                         |
| 1970-01-01T00:00:10 | host2 | 1.0                                                     |
| 1970-01-01T00:00:15 | host2 |                                                         |
| 1970-01-01T00:00:20 | host2 | 1.0                                                     |
+---------------------+-------+---------------------------------------------------------+

SELECT ts, host, gcd(CAST(max(floor(CAST(val as Float64))) RANGE '10s' FILL PREV as INT64) * 4, max(val * 4) RANGE '10s' FILL PREV) * length(host) + 1 FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+------------------------------------------------------------------------------------------------------------------------------------------------+
| ts                  | host  | gcd(MAX(floor(host.val)) RANGE 10s FILL PREV * Int64(4),MAX(host.val * Int64(4)) RANGE 10s FILL PREV) * character_length(host.host) + Int64(1) |
+---------------------+-------+------------------------------------------------------------------------------------------------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1                                                                                                                                              |
| 1970-01-01T00:00:05 | host1 | 1                                                                                                                                              |
| 1970-01-01T00:00:10 | host1 | 21                                                                                                                                             |
| 1970-01-01T00:00:15 | host1 | 21                                                                                                                                             |
| 1970-01-01T00:00:20 | host1 | 41                                                                                                                                             |
| 1970-01-01T00:00:25 | host1 | 41                                                                                                                                             |
| 1970-01-01T00:00:00 | host2 | 61                                                                                                                                             |
| 1970-01-01T00:00:05 | host2 | 61                                                                                                                                             |
| 1970-01-01T00:00:10 | host2 | 81                                                                                                                                             |
| 1970-01-01T00:00:15 | host2 | 81                                                                                                                                             |
| 1970-01-01T00:00:20 | host2 | 101                                                                                                                                            |
| 1970-01-01T00:00:25 | host2 | 101                                                                                                                                            |
+---------------------+-------+------------------------------------------------------------------------------------------------------------------------------------------------+

-- Test Invalid cases
-- 1. error timestamp
SELECT min(val) RANGE 'not_time' FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), sql parser error: not a valid duration string: not_time

SELECT min(val) RANGE '5s' FROM host ALIGN 'not_time';

Error: 2000(InvalidSyntax), sql parser error: not a valid duration string: not_time

-- 2.1 no range param
SELECT min(val) FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), sql parser error: Illegal Range select, no RANGE keyword found in any SelectItem

SELECT min(val) RANGE '10s', max(val) FROM host ALIGN '5s';

Error: 1003(Internal), No field named "MAX(host.val)". Valid fields are "MIN(host.val) RANGE 10s FILL NULL", host.ts, host.host.

SELECT min(val) * 2 RANGE '10s' FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), sql parser error: Can't use the RANGE keyword in Expr 2 without function

SELECT 1 RANGE '10s' FILL NULL FROM host ALIGN '1h' FILL NULL;

Error: 2000(InvalidSyntax), sql parser error: Can't use the RANGE keyword in Expr 1 without function

-- 2.2 no align param
SELECT min(val) RANGE '5s' FROM host;

Error: 1003(Internal), Error during planning: Illegal argument in range select query

-- 2.3 type mismatch
SELECT covar(ceil(val), floor(val)) RANGE '20s' FROM host ALIGN '10s';

Error: 1003(Internal), Internal error: Unsupported data type Int64 for function ceil. This was likely caused by a bug in DataFusion's code and we would welcome that you file an bug report in our issue tracker

-- 2.4 nest query
SELECT min(max(val) RANGE '20s') RANGE '20s' FROM host ALIGN '10s';

Error: 2000(InvalidSyntax), Range Query: Nest Range Query is not allowed

-- 2.5 wrong Aggregate
SELECT rank() OVER (PARTITION BY host ORDER BY ts DESC) RANGE '10s' FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), Range Query: Window functions is not allowed in Range Query

-- 2.6 invalid fill
SELECT min(val) RANGE '5s', min(val) RANGE '5s' FILL NULL FROM host ALIGN '5s';

Error: 1003(Internal), Schema contains duplicate unqualified field name "MIN(host.val) RANGE 5s FILL NULL"

SELECT min(val) RANGE '5s' FROM host ALIGN '5s' FILL 3.0;

Error: 1003(Internal), Error during planning: 3.0 is not a valid fill option, fail to convert to a const value. { Arrow error: Cast error: Cannot cast string '3.0' to value of Int64 type }

DROP TABLE host;

Affected Rows: 0

-- Test on Timestamps of different precisions
CREATE TABLE host_sec (
  ts timestamp(0) time index,
  host STRING PRIMARY KEY,
  val DOUBLE,
);

Affected Rows: 0

INSERT INTO TABLE host_sec VALUES
    (0,  'host1', 0),
    (5,  'host1', null),
    (10, 'host1', 1),
    (15, 'host1', null),
    (20, 'host1', 2),
    (0,  'host2', 3),
    (5,  'host2', null),
    (10, 'host2', 4),
    (15, 'host2', null),
    (20, 'host2', 5);

Affected Rows: 10

SELECT ts, host, min(val) RANGE '5s' FROM host_sec ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+--------------------------------------+
| ts                  | host  | MIN(host_sec.val) RANGE 5s FILL NULL |
+---------------------+-------+--------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                                  |
| 1970-01-01T00:00:05 | host1 |                                      |
| 1970-01-01T00:00:10 | host1 | 1.0                                  |
| 1970-01-01T00:00:15 | host1 |                                      |
| 1970-01-01T00:00:20 | host1 | 2.0                                  |
| 1970-01-01T00:00:00 | host2 | 3.0                                  |
| 1970-01-01T00:00:05 | host2 |                                      |
| 1970-01-01T00:00:10 | host2 | 4.0                                  |
| 1970-01-01T00:00:15 | host2 |                                      |
| 1970-01-01T00:00:20 | host2 | 5.0                                  |
+---------------------+-------+--------------------------------------+

DROP TABLE host_sec;

Affected Rows: 0

