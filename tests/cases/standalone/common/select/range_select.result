CREATE TABLE host (
  ts timestamp(3) time index,
  host STRING PRIMARY KEY,
  val BIGINT,
);

Affected Rows: 0

INSERT INTO TABLE host VALUES
    (0,     'host1', 0),
    (5000,  'host1', null),
    (10000, 'host1', 1),
    (15000, 'host1', null),
    (20000, 'host1', 2),
    (0,     'host2', 3),
    (5000,  'host2', null),
    (10000, 'host2', 4),
    (15000, 'host2', null),
    (20000, 'host2', 5);

Affected Rows: 10

-- Test Fill
SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+------------------------+-----------------------+
| ts                  | host  | MIN(host.val) 10s NULL | MAX(host.val) 5s NULL |
+---------------------+-------+------------------------+-----------------------+
| 1970-01-01T00:00:00 | host1 | 0                      | 0                     |
| 1970-01-01T00:00:05 | host1 | 0                      |                       |
| 1970-01-01T00:00:10 | host1 | 1                      | 1                     |
| 1970-01-01T00:00:15 | host1 | 1                      |                       |
| 1970-01-01T00:00:20 | host1 | 2                      | 2                     |
| 1970-01-01T00:00:25 | host1 | 2                      |                       |
| 1970-01-01T00:00:00 | host2 | 3                      | 3                     |
| 1970-01-01T00:00:05 | host2 | 3                      |                       |
| 1970-01-01T00:00:10 | host2 | 4                      | 4                     |
| 1970-01-01T00:00:15 | host2 | 4                      |                       |
| 1970-01-01T00:00:20 | host2 | 5                      | 5                     |
| 1970-01-01T00:00:25 | host2 | 5                      |                       |
+---------------------+-------+------------------------+-----------------------+

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FILL 6 FROM host ALIGN '5s' FILL NULL ORDER BY host, ts;

+---------------------+-------+------------------------+--------------------+
| ts                  | host  | MIN(host.val) 10s NULL | MAX(host.val) 5s 6 |
+---------------------+-------+------------------------+--------------------+
| 1970-01-01T00:00:00 | host1 | 0                      | 0                  |
| 1970-01-01T00:00:05 | host1 | 0                      | 6                  |
| 1970-01-01T00:00:10 | host1 | 1                      | 1                  |
| 1970-01-01T00:00:15 | host1 | 1                      | 6                  |
| 1970-01-01T00:00:20 | host1 | 2                      | 2                  |
| 1970-01-01T00:00:25 | host1 | 2                      | 6                  |
| 1970-01-01T00:00:00 | host2 | 3                      | 3                  |
| 1970-01-01T00:00:05 | host2 | 3                      | 6                  |
| 1970-01-01T00:00:10 | host2 | 4                      | 4                  |
| 1970-01-01T00:00:15 | host2 | 4                      | 6                  |
| 1970-01-01T00:00:20 | host2 | 5                      | 5                  |
| 1970-01-01T00:00:25 | host2 | 5                      | 6                  |
+---------------------+-------+------------------------+--------------------+

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FROM host ALIGN '5s' FILL PREV ORDER BY host, ts;

+---------------------+-------+------------------------+-----------------------+
| ts                  | host  | MIN(host.val) 10s PREV | MAX(host.val) 5s PREV |
+---------------------+-------+------------------------+-----------------------+
| 1970-01-01T00:00:00 | host1 | 0                      | 0                     |
| 1970-01-01T00:00:05 | host1 | 0                      | 0                     |
| 1970-01-01T00:00:10 | host1 | 1                      | 1                     |
| 1970-01-01T00:00:15 | host1 | 1                      | 1                     |
| 1970-01-01T00:00:20 | host1 | 2                      | 2                     |
| 1970-01-01T00:00:25 | host1 | 2                      | 2                     |
| 1970-01-01T00:00:00 | host2 | 3                      | 3                     |
| 1970-01-01T00:00:05 | host2 | 3                      | 3                     |
| 1970-01-01T00:00:10 | host2 | 4                      | 4                     |
| 1970-01-01T00:00:15 | host2 | 4                      | 4                     |
| 1970-01-01T00:00:20 | host2 | 5                      | 5                     |
| 1970-01-01T00:00:25 | host2 | 5                      | 5                     |
+---------------------+-------+------------------------+-----------------------+

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FROM host ALIGN '5s' FILL LINEAR ORDER BY host, ts;

+---------------------+-------+--------------------------+-------------------------+
| ts                  | host  | MIN(host.val) 10s LINEAR | MAX(host.val) 5s LINEAR |
+---------------------+-------+--------------------------+-------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                      | 0.0                     |
| 1970-01-01T00:00:05 | host1 | 0.0                      | 0.5                     |
| 1970-01-01T00:00:10 | host1 | 1.0                      | 1.0                     |
| 1970-01-01T00:00:15 | host1 | 1.0                      | 1.5                     |
| 1970-01-01T00:00:20 | host1 | 2.0                      | 2.0                     |
| 1970-01-01T00:00:25 | host1 | 2.0                      |                         |
| 1970-01-01T00:00:00 | host2 | 3.0                      | 3.0                     |
| 1970-01-01T00:00:05 | host2 | 3.0                      | 3.5                     |
| 1970-01-01T00:00:10 | host2 | 4.0                      | 4.0                     |
| 1970-01-01T00:00:15 | host2 | 4.0                      | 4.5                     |
| 1970-01-01T00:00:20 | host2 | 5.0                      | 5.0                     |
| 1970-01-01T00:00:25 | host2 | 5.0                      |                         |
+---------------------+-------+--------------------------+-------------------------+

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FROM host ALIGN '5s' FILL 6 ORDER BY host, ts;

+---------------------+-------+---------------------+--------------------+
| ts                  | host  | MIN(host.val) 10s 6 | MAX(host.val) 5s 6 |
+---------------------+-------+---------------------+--------------------+
| 1970-01-01T00:00:00 | host1 | 0                   | 0                  |
| 1970-01-01T00:00:05 | host1 | 0                   | 6                  |
| 1970-01-01T00:00:10 | host1 | 1                   | 1                  |
| 1970-01-01T00:00:15 | host1 | 1                   | 6                  |
| 1970-01-01T00:00:20 | host1 | 2                   | 2                  |
| 1970-01-01T00:00:25 | host1 | 2                   | 6                  |
| 1970-01-01T00:00:00 | host2 | 3                   | 3                  |
| 1970-01-01T00:00:05 | host2 | 3                   | 6                  |
| 1970-01-01T00:00:10 | host2 | 4                   | 4                  |
| 1970-01-01T00:00:15 | host2 | 4                   | 6                  |
| 1970-01-01T00:00:20 | host2 | 5                   | 5                  |
| 1970-01-01T00:00:25 | host2 | 5                   | 6                  |
+---------------------+-------+---------------------+--------------------+

-- Test nest sql
SELECT ts, host, foo FROM (SELECT ts, host, ((min(val)+max(val)) * 2) RANGE '10s' AS foo FROM host ALIGN '5s') WHERE foo > 8 ORDER BY host, ts;

+---------------------+-------+-----+
| ts                  | host  | foo |
+---------------------+-------+-----+
| 1970-01-01T00:00:00 | host2 | 12  |
| 1970-01-01T00:00:05 | host2 | 12  |
| 1970-01-01T00:00:10 | host2 | 16  |
| 1970-01-01T00:00:15 | host2 | 16  |
| 1970-01-01T00:00:20 | host2 | 20  |
| 1970-01-01T00:00:25 | host2 | 20  |
+---------------------+-------+-----+

SELECT ts, b, ((min(c)+max(c))/4) RANGE '10s' FROM (SELECT ts, host AS b, val AS c FROM host WHERE val > 2) ALIGN '5s' BY (b) ORDER BY b, ts;

+---------------------+-------+----------------------------------------------+
| ts                  | b     | MIN(c) 10s NULL + MAX(c) 10s NULL / Int64(4) |
+---------------------+-------+----------------------------------------------+
| 1970-01-01T00:00:00 | host2 | 1                                            |
| 1970-01-01T00:00:05 | host2 | 1                                            |
| 1970-01-01T00:00:10 | host2 | 2                                            |
| 1970-01-01T00:00:15 | host2 | 2                                            |
| 1970-01-01T00:00:20 | host2 | 2                                            |
| 1970-01-01T00:00:25 | host2 | 2                                            |
+---------------------+-------+----------------------------------------------+

-- Test range expr calculate
SELECT ts, host, (min(CAST(val AS Float64) * 2.0)/2) RANGE '10s', (max(CAST(val AS Float64) * 2.0)/2) RANGE '5s' FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+------------------------------------------------+-----------------------------------------------+
| ts                  | host  | MIN(host.val * Float64(2)) 10s NULL / Int64(2) | MAX(host.val * Float64(2)) 5s NULL / Int64(2) |
+---------------------+-------+------------------------------------------------+-----------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                                            | 0.0                                           |
| 1970-01-01T00:00:05 | host1 | 0.0                                            |                                               |
| 1970-01-01T00:00:10 | host1 | 1.0                                            | 1.0                                           |
| 1970-01-01T00:00:15 | host1 | 1.0                                            |                                               |
| 1970-01-01T00:00:20 | host1 | 2.0                                            | 2.0                                           |
| 1970-01-01T00:00:25 | host1 | 2.0                                            |                                               |
| 1970-01-01T00:00:00 | host2 | 3.0                                            | 3.0                                           |
| 1970-01-01T00:00:05 | host2 | 3.0                                            |                                               |
| 1970-01-01T00:00:10 | host2 | 4.0                                            | 4.0                                           |
| 1970-01-01T00:00:15 | host2 | 4.0                                            |                                               |
| 1970-01-01T00:00:20 | host2 | 5.0                                            | 5.0                                           |
| 1970-01-01T00:00:25 | host2 | 5.0                                            |                                               |
+---------------------+-------+------------------------------------------------+-----------------------------------------------+

SELECT ts, covar(val, val) RANGE '20s', host FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+----------------------------------------+-------+
| ts                  | COVARIANCE(host.val,host.val) 20s NULL | host  |
+---------------------+----------------------------------------+-------+
| 1970-01-01T00:00:00 |                                        | host1 |
| 1970-01-01T00:00:10 | 0.5                                    | host1 |
| 1970-01-01T00:00:20 | 0.5                                    | host1 |
| 1970-01-01T00:00:30 |                                        | host1 |
| 1970-01-01T00:00:00 |                                        | host2 |
| 1970-01-01T00:00:10 | 0.5                                    | host2 |
| 1970-01-01T00:00:20 | 0.5                                    | host2 |
| 1970-01-01T00:00:30 |                                        | host2 |
+---------------------+----------------------------------------+-------+

SELECT ts, covar(ceil(CAST(val AS Float64)), floor(CAST(val AS Float64))) RANGE '20s', host FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-----------------------------------------------------+-------+
| ts                  | COVARIANCE(ceil(host.val),floor(host.val)) 20s NULL | host  |
+---------------------+-----------------------------------------------------+-------+
| 1970-01-01T00:00:00 |                                                     | host1 |
| 1970-01-01T00:00:10 | 0.5                                                 | host1 |
| 1970-01-01T00:00:20 | 0.5                                                 | host1 |
| 1970-01-01T00:00:30 |                                                     | host1 |
| 1970-01-01T00:00:00 |                                                     | host2 |
| 1970-01-01T00:00:10 | 0.5                                                 | host2 |
| 1970-01-01T00:00:20 | 0.5                                                 | host2 |
| 1970-01-01T00:00:30 |                                                     | host2 |
+---------------------+-----------------------------------------------------+-------+

SELECT ts, host, ceil((min(val * 2) + max(val * 2)) RANGE '20s' + 1.0) FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-------+------------------------------------------------------------------------------------------+
| ts                  | host  | ceil(MIN(host.val * Int64(2)) 20s NULL + MAX(host.val * Int64(2)) 20s NULL + Float64(1)) |
+---------------------+-------+------------------------------------------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1.0                                                                                      |
| 1970-01-01T00:00:10 | host1 | 3.0                                                                                      |
| 1970-01-01T00:00:20 | host1 | 7.0                                                                                      |
| 1970-01-01T00:00:30 | host1 | 9.0                                                                                      |
| 1970-01-01T00:00:00 | host2 | 13.0                                                                                     |
| 1970-01-01T00:00:10 | host2 | 15.0                                                                                     |
| 1970-01-01T00:00:20 | host2 | 19.0                                                                                     |
| 1970-01-01T00:00:30 | host2 | 21.0                                                                                     |
+---------------------+-------+------------------------------------------------------------------------------------------+

SELECT ts, host, min(val) RANGE '10s' FILL PREV + min(val) RANGE '10s' FILL PREV FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+-------------------------------------------------+
| ts                  | host  | MIN(host.val) 10s PREV + MIN(host.val) 10s PREV |
+---------------------+-------+-------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 0                                               |
| 1970-01-01T00:00:05 | host1 | 0                                               |
| 1970-01-01T00:00:10 | host1 | 2                                               |
| 1970-01-01T00:00:15 | host1 | 2                                               |
| 1970-01-01T00:00:20 | host1 | 4                                               |
| 1970-01-01T00:00:25 | host1 | 4                                               |
| 1970-01-01T00:00:00 | host2 | 6                                               |
| 1970-01-01T00:00:05 | host2 | 6                                               |
| 1970-01-01T00:00:10 | host2 | 8                                               |
| 1970-01-01T00:00:15 | host2 | 8                                               |
| 1970-01-01T00:00:20 | host2 | 10                                              |
| 1970-01-01T00:00:25 | host2 | 10                                              |
+---------------------+-------+-------------------------------------------------+

SELECT ts, host, floor(cos(ceil(sin(min(val) RANGE '20s'))) )FROM host ALIGN '10s' ORDER BY host, ts;

+---------------------+-------+-----------------------------------------------+
| ts                  | host  | floor(cos(ceil(sin(MIN(host.val) 20s NULL)))) |
+---------------------+-------+-----------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1.0                                           |
| 1970-01-01T00:00:10 | host1 | 1.0                                           |
| 1970-01-01T00:00:20 | host1 | 0.0                                           |
| 1970-01-01T00:00:30 | host1 | 0.0                                           |
| 1970-01-01T00:00:00 | host2 | 0.0                                           |
| 1970-01-01T00:00:10 | host2 | 0.0                                           |
| 1970-01-01T00:00:20 | host2 | 1.0                                           |
| 1970-01-01T00:00:30 | host2 | 1.0                                           |
+---------------------+-------+-----------------------------------------------+

SELECT ts, host, gcd(max(val) RANGE '10s' FILL 1, max(val) RANGE '10s' FILL 1) * length(host) + 1 FROM host ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+---------------------------------------------------------------------------------------+
| ts                  | host  | gcd(MAX(host.val) 10s 1,MAX(host.val) 10s 1) * character_length(host.host) + Int64(1) |
+---------------------+-------+---------------------------------------------------------------------------------------+
| 1970-01-01T00:00:00 | host1 | 1                                                                                     |
| 1970-01-01T00:00:05 | host1 | 1                                                                                     |
| 1970-01-01T00:00:10 | host1 | 6                                                                                     |
| 1970-01-01T00:00:15 | host1 | 6                                                                                     |
| 1970-01-01T00:00:20 | host1 | 11                                                                                    |
| 1970-01-01T00:00:25 | host1 | 11                                                                                    |
| 1970-01-01T00:00:00 | host2 | 16                                                                                    |
| 1970-01-01T00:00:05 | host2 | 16                                                                                    |
| 1970-01-01T00:00:10 | host2 | 21                                                                                    |
| 1970-01-01T00:00:15 | host2 | 21                                                                                    |
| 1970-01-01T00:00:20 | host2 | 26                                                                                    |
| 1970-01-01T00:00:25 | host2 | 26                                                                                    |
+---------------------+-------+---------------------------------------------------------------------------------------+

-- Test Invalid cases
-- 1. error timestamp
SELECT min(val) RANGE 'not_time' FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), sql parser error: not a valid duration string: not_time

SELECT min(val) RANGE '5s' FROM host ALIGN 'not_time';

Error: 2000(InvalidSyntax), sql parser error: not a valid duration string: not_time

-- 2.1 no range param
SELECT min(val) FROM host ALIGN '5s';

Error: 2000(InvalidSyntax), sql parser error: Illegal Range select, no RANGE keyword found in any SelectItem

SELECT min(val) RANGE '10s', max(val) FROM host ALIGN '5s';

Error: 1003(Internal), No field named "MAX(host.val)". Valid fields are "MIN(host.val) 10s NULL", host.ts, host.host.

SELECT 1 RANGE '10s' FILL NULL FROM host ALIGN '1h' FILL NULL;

Error: 2000(InvalidSyntax), sql parser error: Can't use the RANGE keyword in Expr 1 without function

-- 2.2 no align param
SELECT min(val) RANGE '5s' FROM host;

Error: 1003(Internal), Error during planning: Illegal argument in range select query

-- 2.3 type mismatch
SELECT ts, covar(ceil(val), floor(val)) RANGE '20s', host FROM host ALIGN '10s' ORDER BY host, ts;

Error: 1003(Internal), Internal error: Unsupported data type Int64 for function ceil. This was likely caused by a bug in DataFusion's code and we would welcome that you file an bug report in our issue tracker

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '5s' FROM host ALIGN '5s' FILL 3.0 ORDER BY host, ts;

Error: 1003(Internal), Error during planning: 3.0 is not a valid fill option, fail to convert to a const value. { Arrow error: Cast error: Cannot cast string '3.0' to value of Int64 type }

-- 2.4 nest query
SELECT ts, covar(max(val) RANGE '20s', floor(val)) RANGE '20s', host FROM host ALIGN '10s' ORDER BY host, ts;

Error: 2000(InvalidSyntax), Range Query: Nest Range Query is not allowed

-- 2.5 wrong Aggregate
SELECT max(ts) RANGE '20s', host FROM host ALIGN '10s' ORDER BY host, ts;

Error: 3000(PlanQuery), No field named ts. Valid fields are "range_fn(MAX(host.ts),Utf8(""20s""),Utf8(""""),Utf8(""0""),Utf8(""10s""))", host.host, host.host, "MAX(host.ts)".

SELECT ts, host, rank() OVER (PARTITION BY host ORDER BY ts DESC) RANGE '10s' FROM host ALIGN '5s' ORDER BY host, ts;

Error: 2000(InvalidSyntax), Range Query: Window functions is not allowed in Range Query

DROP TABLE host;

Affected Rows: 0

-- Test on Timestamps of different precisions
CREATE TABLE host_sec (
  ts timestamp(0) time index,
  host STRING PRIMARY KEY,
  val DOUBLE,
);

Affected Rows: 0

INSERT INTO TABLE host_sec VALUES
    (0,  'host1', 0.0),
    (5,  'host1', 1.0),
    (10, 'host1', 2.0),
    (15, 'host1', 3.0),
    (20, 'host1', 4.0),
    (25, 'host1', 5.0),
    (30, 'host1', 6.0),
    (35, 'host1', 7.0),
    (40, 'host1', 8.0),
    (0,  'host2', 9.0),
    (5,  'host2', 10.0),
    (10, 'host2', 11.0),
    (15, 'host2', 12.0),
    (20, 'host2', 13.0),
    (25, 'host2', 14.0),
    (30, 'host2', 15.0),
    (35, 'host2', 16.0),
    (40, 'host2', 17.0);

Affected Rows: 18

SELECT ts, host, min(val) RANGE '10s', max(val) RANGE '10s' FROM host_sec ALIGN '5s' ORDER BY host, ts;

+---------------------+-------+----------------------------+----------------------------+
| ts                  | host  | MIN(host_sec.val) 10s NULL | MAX(host_sec.val) 10s NULL |
+---------------------+-------+----------------------------+----------------------------+
| 1970-01-01T00:00:00 | host1 | 0.0                        | 0.0                        |
| 1970-01-01T00:00:05 | host1 | 0.0                        | 1.0                        |
| 1970-01-01T00:00:10 | host1 | 1.0                        | 2.0                        |
| 1970-01-01T00:00:15 | host1 | 2.0                        | 3.0                        |
| 1970-01-01T00:00:20 | host1 | 3.0                        | 4.0                        |
| 1970-01-01T00:00:25 | host1 | 4.0                        | 5.0                        |
| 1970-01-01T00:00:30 | host1 | 5.0                        | 6.0                        |
| 1970-01-01T00:00:35 | host1 | 6.0                        | 7.0                        |
| 1970-01-01T00:00:40 | host1 | 7.0                        | 8.0                        |
| 1970-01-01T00:00:45 | host1 | 8.0                        | 8.0                        |
| 1970-01-01T00:00:00 | host2 | 9.0                        | 9.0                        |
| 1970-01-01T00:00:05 | host2 | 9.0                        | 10.0                       |
| 1970-01-01T00:00:10 | host2 | 10.0                       | 11.0                       |
| 1970-01-01T00:00:15 | host2 | 11.0                       | 12.0                       |
| 1970-01-01T00:00:20 | host2 | 12.0                       | 13.0                       |
| 1970-01-01T00:00:25 | host2 | 13.0                       | 14.0                       |
| 1970-01-01T00:00:30 | host2 | 14.0                       | 15.0                       |
| 1970-01-01T00:00:35 | host2 | 15.0                       | 16.0                       |
| 1970-01-01T00:00:40 | host2 | 16.0                       | 17.0                       |
| 1970-01-01T00:00:45 | host2 | 17.0                       | 17.0                       |
+---------------------+-------+----------------------------+----------------------------+

DROP TABLE host_sec;

Affected Rows: 0

