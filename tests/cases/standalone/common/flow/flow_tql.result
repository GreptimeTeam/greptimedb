CREATE TABLE http_requests (
  ts timestamp(3) time index,
  host STRING,
  idc STRING,
  val BIGINT,
  PRIMARY KEY(host, idc),
);

Affected Rows: 0

CREATE FLOW calc_reqs SINK TO cnt_reqs AS
TQL EVAL (now() - '1m'::interval, now(), '5s') count_values("status_code", http_requests);

Affected Rows: 0

INSERT INTO TABLE http_requests VALUES
    (now() - '15s'::interval, 'host1', 'idc1', 200),
    (now() - '15s'::interval, 'host2', 'idc1', 200),
    (now() - '15s'::interval, 'host3', 'idc2', 200),
    (now() - '15s'::interval, 'host4', 'idc2', 401),
    (now() - '10s'::interval, 'host1', 'idc1', 404),
    (now() - '10s'::interval, 'host2', 'idc1', 401),
    (now() - '10s'::interval, 'host3', 'idc2', 404),
    (now() - '10s'::interval, 'host4', 'idc2', 500),
    (now() - '5s'::interval, 'host1', 'idc1', 200),
    (now() - '5s'::interval, 'host2', 'idc1', 200),
    (now() - '5s'::interval, 'host3', 'idc2', 201),
    (now() - '5s'::interval, 'host4', 'idc2', 201),
    (now(), 'host1', 'idc1', 500),
    (now(), 'host2', 'idc1', 500),
    (now(), 'host3', 'idc2', 500),
    (now(), 'host4', 'idc2', 500);

Affected Rows: 16

-- SQLNESS REPLACE (ADMIN\sFLUSH_FLOW\('\w+'\)\s+\|\n\+-+\+\n\|\s+)[0-9]+\s+\| $1 FLOW_FLUSHED  |
ADMIN FLUSH_FLOW('calc_reqs');

+-------------------------------+
| ADMIN FLUSH_FLOW('calc_reqs') |
+-------------------------------+
|  FLOW_FLUSHED  |
+-------------------------------+

SELECT "count(http_requests.val)" as cnt, status_code FROM cnt_reqs ORDER BY status_code, cnt DESC;

+-----+-------------+
| cnt | status_code |
+-----+-------------+
| 3   | 200         |
| 2   | 200         |
| 2   | 201         |
| 1   | 401         |
| 1   | 401         |
| 2   | 404         |
| 1   | 500         |
+-----+-------------+

DROP FLOW calc_reqs;

Affected Rows: 0

DROP TABLE http_requests;

Affected Rows: 0

DROP TABLE cnt_reqs;

Affected Rows: 0

