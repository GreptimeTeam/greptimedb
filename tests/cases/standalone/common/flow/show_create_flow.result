CREATE TABLE numbers_input_show (
    number INT,
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY(number),
    TIME INDEX(ts)
);

Affected Rows: 0

create table out_num_cnt_show (
    number INT,
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP TIME INDEX);

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

++
++

SHOW FLOWS LIKE 'filter_numbers_show';

++
++

CREATE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 10;

Affected Rows: 0

SHOW CREATE FLOW filter_numbers_show;

+---------------------+------------------------------------------------------------+
| Flow                | Create Flow                                                |
+---------------------+------------------------------------------------------------+
| filter_numbers_show | CREATE OR REPLACE FLOW IF NOT EXISTS filter_numbers_show   |
|                     | SINK TO out_num_cnt_show                                   |
|                     | AS SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+------------------------------------------------------------+

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

SHOW FLOWS LIKE 'filter_numbers_show';

+---------------------+
| Flows               |
+---------------------+
| filter_numbers_show |
+---------------------+

drop flow filter_numbers_show;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

++
++

SHOW FLOWS LIKE 'filter_numbers_show';

++
++

-- also test `CREATE OR REPLACE` and `IF NOT EXISTS`
-- (flow exists, replace, if not exists)=(false, false, false)
CREATE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 10;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

-- this one should error out
-- (flow exists, replace, if not exists)=(true, false, false)
CREATE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 15;

Error: 8000(FlowAlreadyExists), Flow already exists: greptime.filter_numbers_show

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

-- after this one, the flow SHOULD NOT be replaced
-- (flow exists, replace, if not exists)=(true, false, true)
CREATE FLOW IF NOT EXISTS filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 5;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

-- makesure it's not replaced in flownode
INSERT INTO numbers_input_show VALUES (10, now());

Affected Rows: 1

SELECT number FROM out_num_cnt_show;

++
++

-- after this, the flow SHOULD be replaced
-- (flow exists, replace, if not exists)=(true, true, false)
CREATE OR REPLACE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 3;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

-- makesure it's replaced in flownode
INSERT INTO numbers_input_show VALUES (10, now());

Affected Rows: 1

SELECT number FROM out_num_cnt_show;

++
++

-- after this, the flow SHOULD error out since having both `replace` and `if not exists`
-- (flow exists, replace, if not exists)=(true, true, true)
CREATE OR REPLACE FLOW IF NOT EXISTS filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > 0;

Error: 1001(Unsupported), Unsupported operation Create flow with both `IF NOT EXISTS` and `OR REPLACE`

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > 10 |
+---------------------+---------------+---------------------------------------------------------+

DROP FLOW filter_numbers_show;

Affected Rows: 0

-- following always create since didn't exist
-- (flow exists, replace, if not exists)=(false, true, true)
CREATE OR REPLACE FLOW IF NOT EXISTS filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > -1;

Error: 1001(Unsupported), Unsupported operation Create flow with both `IF NOT EXISTS` and `OR REPLACE`

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

++
++

DROP FLOW filter_numbers_show;

Error: 8001(FlowNotFound), Flow not found: greptime.filter_numbers_show

-- (flow exists, replace, if not exists)=(false, true, false)
CREATE OR REPLACE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > -2;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > -2 |
+---------------------+---------------+---------------------------------------------------------+

DROP FLOW filter_numbers_show;

Affected Rows: 0

-- (flow exists, replace, if not exists)=(false, false, true)
CREATE OR REPLACE FLOW filter_numbers_show SINK TO out_num_cnt_show AS SELECT number FROM numbers_input_show where number > -3;

Affected Rows: 0

SELECT flow_name, table_catalog, flow_definition FROM INFORMATION_SCHEMA.FLOWS WHERE flow_name='filter_numbers_show';

+---------------------+---------------+---------------------------------------------------------+
| flow_name           | table_catalog | flow_definition                                         |
+---------------------+---------------+---------------------------------------------------------+
| filter_numbers_show | greptime      | SELECT number FROM numbers_input_show WHERE number > -3 |
+---------------------+---------------+---------------------------------------------------------+

DROP FLOW filter_numbers_show;

Affected Rows: 0

drop table out_num_cnt_show;

Affected Rows: 0

drop table numbers_input_show;

Affected Rows: 0

