create table count_total (
    ts timestamp time index,
    tag_a string,
    tag_b string,
    val double,
    primary key (tag_a, tag_b),
);

Affected Rows: 0

-- if `RangeManipulate` can be encoded/decoded correctly in substrait, the following two queries should pass(for now it simply wouldn't push down)
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (partitioning.*) REDACTED
tql explain (0, 100, '1s') 
    increase(count_total{
      tag_a="ffa",
      tag_b="8c64"
    }[1h])[12h:1h];

+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| plan_type     | plan                                                                                                                                                                                                    |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| logical_plan  | PromRangeManipulate: req range=[0..0], interval=[300000], eval range=[43200000], time index=[ts], values=["prom_increase(ts_range,val,ts,Int64(3600000))"]                                              |
|               |   Filter: prom_increase(ts_range,val,ts,Int64(3600000)) IS NOT NULL                                                                                                                                     |
|               |     Projection: count_total.ts, prom_increase(ts_range, val, count_total.ts, Int64(3600000)) AS prom_increase(ts_range,val,ts,Int64(3600000)), count_total.tag_a, count_total.tag_b                     |
|               |       PromRangeManipulate: req range=[-39600000..0], interval=[3600000], eval range=[3600000], time index=[ts], values=["val"]                                                                          |
|               |         Projection: count_total.ts, count_total.tag_a, count_total.tag_b, count_total.val                                                                                                               |
|               |           MergeScan [is_placeholder=false, remote_input=[                                                                                                                                               |
|               | PromSeriesNormalize: offset=[0], time index=[ts], filter NaN: [true]                                                                                                                                    |
|               |   PromSeriesDivide: tags=["tag_a", "tag_b"]                                                                                                                                                             |
|               |     Sort: count_total.tag_a ASC NULLS FIRST, count_total.tag_b ASC NULLS FIRST, count_total.ts ASC NULLS FIRST                                                                                          |
|               |       Filter: count_total.tag_b = Utf8("8c64") AND count_total.tag_a = Utf8("ffa") AND count_total.ts >= TimestampMillisecond(-43500000, None) AND count_total.ts <= TimestampMillisecond(300000, None) |
|               |         TableScan: count_total                                                                                                                                                                          |
|               | ]]                                                                                                                                                                                                      |
| physical_plan | PromRangeManipulateExec: req range=[0..0], interval=[300000], eval range=[43200000], time index=[ts]                                                                                                    |
|               |   CoalesceBatchesExec: target_batch_size=8192                                                                                                                                                           |
|               |     FilterExec: prom_increase(ts_range,val,ts,Int64(3600000))@1 IS NOT NULL                                                                                                                             |
|               |       ProjectionExec: expr=[ts@0 as ts, prom_increase(ts_range@4, val@3, ts@0, 3600000) as prom_increase(ts_range,val,ts,Int64(3600000)), tag_a@1 as tag_a, tag_b@2 as tag_b]                           |
|               |         PromRangeManipulateExec: req range=[-39600000..0], interval=[3600000], eval range=[3600000], time index=[ts]                                                                                    |
|               |           CooperativeExec                                                                                                                                                                               |
|               |             MergeScanExec: REDACTED
|               |                                                                                                                                                                                                         |
+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

tql eval (0, 100, '1s') 
    increase(count_total{
      tag_a="ffa",
      tag_b="8c64"
    }[1h])[12h:1h];

++
++

drop table count_total;

Affected Rows: 0

