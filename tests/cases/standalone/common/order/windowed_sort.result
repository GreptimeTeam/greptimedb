-- Test without PK, with a windowed sort query.
CREATE TABLE test(i INTEGER, t TIMESTAMP TIME INDEX) WITH('compaction.type'='twcs', 'compaction.twcs.max_inactive_window_files'='4');

Affected Rows: 0

INSERT INTO test VALUES (1, 1), (NULL, 2), (1, 3);

Affected Rows: 3

ADMIN FLUSH_TABLE('test');

+---------------------------+
| ADMIN FLUSH_TABLE('test') |
+---------------------------+
| 0                         |
+---------------------------+

INSERT INTO test VALUES (2, 4), (2, 5), (NULL, 6);

Affected Rows: 3

ADMIN FLUSH_TABLE('test');

+---------------------------+
| ADMIN FLUSH_TABLE('test') |
+---------------------------+
| 0                         |
+---------------------------+

INSERT INTO test VALUES (3, 7), (3, 8), (3, 9);

Affected Rows: 3

ADMIN FLUSH_TABLE('test');

+---------------------------+
| ADMIN FLUSH_TABLE('test') |
+---------------------------+
| 0                         |
+---------------------------+

INSERT INTO test VALUES (4, 10), (4, 11), (4, 12);

Affected Rows: 3

SELECT * FROM test ORDER BY t LIMIT 5;

+---+-------------------------+
| i | t                       |
+---+-------------------------+
| 1 | 1970-01-01T00:00:00.001 |
|   | 1970-01-01T00:00:00.002 |
| 1 | 1970-01-01T00:00:00.003 |
| 2 | 1970-01-01T00:00:00.004 |
| 2 | 1970-01-01T00:00:00.005 |
+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test ORDER BY t LIMIT 5;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@1 ASC NULLS LAST], fetch=5 REDACTED
|_|_|_WindowedSortExec: expr=t@1 ASC NULLS LAST num_ranges=4 fetch=5 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 5_|
+-+-+-+

SELECT * FROM test ORDER BY t DESC LIMIT 5;

+---+-------------------------+
| i | t                       |
+---+-------------------------+
| 4 | 1970-01-01T00:00:00.012 |
| 4 | 1970-01-01T00:00:00.011 |
| 4 | 1970-01-01T00:00:00.010 |
| 3 | 1970-01-01T00:00:00.009 |
| 3 | 1970-01-01T00:00:00.008 |
+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test ORDER BY t DESC LIMIT 5;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@1 DESC], fetch=5 REDACTED
|_|_|_WindowedSortExec: expr=t@1 DESC num_ranges=4 fetch=5 REDACTED
|_|_|_PartSortExec: expr=t@1 DESC num_ranges=4 limit=5 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 5_|
+-+-+-+

-- Filter on a field.
SELECT * FROM test where i > 2 ORDER BY t LIMIT 4;

+---+-------------------------+
| i | t                       |
+---+-------------------------+
| 3 | 1970-01-01T00:00:00.007 |
| 3 | 1970-01-01T00:00:00.008 |
| 3 | 1970-01-01T00:00:00.009 |
| 4 | 1970-01-01T00:00:00.010 |
+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test where i > 2 ORDER BY t LIMIT 4;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@1 ASC NULLS LAST], fetch=4 REDACTED
|_|_|_WindowedSortExec: expr=t@1 ASC NULLS LAST num_ranges=4 fetch=4 REDACTED
|_|_|_CoalesceBatchesExec: target_batch_size=8192 REDACTED
|_|_|_FilterExec: i@0 > 2 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 4_|
+-+-+-+

-- Filter on a field.
SELECT * FROM test where i > 2 ORDER BY t DESC LIMIT 4;

+---+-------------------------+
| i | t                       |
+---+-------------------------+
| 4 | 1970-01-01T00:00:00.012 |
| 4 | 1970-01-01T00:00:00.011 |
| 4 | 1970-01-01T00:00:00.010 |
| 3 | 1970-01-01T00:00:00.009 |
+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test where i > 2 ORDER BY t DESC LIMIT 4;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@1 DESC], fetch=4 REDACTED
|_|_|_WindowedSortExec: expr=t@1 DESC num_ranges=4 fetch=4 REDACTED
|_|_|_PartSortExec: expr=t@1 DESC num_ranges=4 limit=4 REDACTED
|_|_|_CoalesceBatchesExec: target_batch_size=8192 REDACTED
|_|_|_FilterExec: i@0 > 2 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 4_|
+-+-+-+

-- Filter on the time index.
SELECT * FROM test where t > 8 ORDER BY t DESC LIMIT 4;

+---+-------------------------+
| i | t                       |
+---+-------------------------+
| 4 | 1970-01-01T00:00:00.012 |
| 4 | 1970-01-01T00:00:00.011 |
| 4 | 1970-01-01T00:00:00.010 |
| 3 | 1970-01-01T00:00:00.009 |
+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test where t > 8 ORDER BY t DESC LIMIT 4;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@1 DESC], fetch=4 REDACTED
|_|_|_WindowedSortExec: expr=t@1 DESC num_ranges=2 fetch=4 REDACTED
|_|_|_PartSortExec: expr=t@1 DESC num_ranges=2 limit=4 REDACTED
|_|_|_CoalesceBatchesExec: target_batch_size=8192 REDACTED
|_|_|_FilterExec: t@1 > 8 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=2 (1 memtable ranges, 1 file 1 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 4_|
+-+-+-+

DROP TABLE test;

Affected Rows: 0

-- Test with PK, with a windowed sort query.
CREATE TABLE test_pk(pk INTEGER PRIMARY KEY, i INTEGER, t TIMESTAMP TIME INDEX) WITH('compaction.type'='twcs', 'compaction.twcs.max_inactive_window_files'='4');

Affected Rows: 0

INSERT INTO test_pk VALUES (1, 1, 1), (2, NULL, 2), (3, 1, 3);

Affected Rows: 3

ADMIN FLUSH_TABLE('test_pk');

+------------------------------+
| ADMIN FLUSH_TABLE('test_pk') |
+------------------------------+
| 0                            |
+------------------------------+

INSERT INTO test_pk VALUES (4, 2, 4), (5, 2, 5), (6, NULL, 6);

Affected Rows: 3

ADMIN FLUSH_TABLE('test_pk');

+------------------------------+
| ADMIN FLUSH_TABLE('test_pk') |
+------------------------------+
| 0                            |
+------------------------------+

INSERT INTO test_pk VALUES (7, 3, 7), (8, 3, 8), (9, 3, 9);

Affected Rows: 3

ADMIN FLUSH_TABLE('test_pk');

+------------------------------+
| ADMIN FLUSH_TABLE('test_pk') |
+------------------------------+
| 0                            |
+------------------------------+

INSERT INTO test_pk VALUES (10, 4, 10), (11, 4, 11), (12, 4, 12);

Affected Rows: 3

SELECT * FROM test_pk ORDER BY t LIMIT 5;

+----+---+-------------------------+
| pk | i | t                       |
+----+---+-------------------------+
| 1  | 1 | 1970-01-01T00:00:00.001 |
| 2  |   | 1970-01-01T00:00:00.002 |
| 3  | 1 | 1970-01-01T00:00:00.003 |
| 4  | 2 | 1970-01-01T00:00:00.004 |
| 5  | 2 | 1970-01-01T00:00:00.005 |
+----+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test_pk ORDER BY t LIMIT 5;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@2 ASC NULLS LAST], fetch=5 REDACTED
|_|_|_WindowedSortExec: expr=t@2 ASC NULLS LAST num_ranges=4 fetch=5 REDACTED
|_|_|_PartSortExec: expr=t@2 ASC NULLS LAST num_ranges=4 limit=5 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 5_|
+-+-+-+

SELECT * FROM test_pk ORDER BY t DESC LIMIT 5;

+----+---+-------------------------+
| pk | i | t                       |
+----+---+-------------------------+
| 12 | 4 | 1970-01-01T00:00:00.012 |
| 11 | 4 | 1970-01-01T00:00:00.011 |
| 10 | 4 | 1970-01-01T00:00:00.010 |
| 9  | 3 | 1970-01-01T00:00:00.009 |
| 8  | 3 | 1970-01-01T00:00:00.008 |
+----+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test_pk ORDER BY t DESC LIMIT 5;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@2 DESC], fetch=5 REDACTED
|_|_|_WindowedSortExec: expr=t@2 DESC num_ranges=4 fetch=5 REDACTED
|_|_|_PartSortExec: expr=t@2 DESC num_ranges=4 limit=5 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 5_|
+-+-+-+

-- Filter on a pk column.
SELECT * FROM test_pk where pk > 7 ORDER BY t LIMIT 5;

+----+---+-------------------------+
| pk | i | t                       |
+----+---+-------------------------+
| 8  | 3 | 1970-01-01T00:00:00.008 |
| 9  | 3 | 1970-01-01T00:00:00.009 |
| 10 | 4 | 1970-01-01T00:00:00.010 |
| 11 | 4 | 1970-01-01T00:00:00.011 |
| 12 | 4 | 1970-01-01T00:00:00.012 |
+----+---+-------------------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT * FROM test_pk where pk > 7 ORDER BY t LIMIT 5;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_SortPreservingMergeExec: [t@2 ASC NULLS LAST], fetch=5 REDACTED
|_|_|_WindowedSortExec: expr=t@2 ASC NULLS LAST num_ranges=4 fetch=5 REDACTED
|_|_|_PartSortExec: expr=t@2 ASC NULLS LAST num_ranges=4 limit=5 REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=4 (1 memtable ranges, 3 file 3 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 5_|
+-+-+-+

DROP TABLE test_pk;

Affected Rows: 0

-- test if handle aliased sort expr correctly
CREATE TABLE IF NOT EXISTS lightning (
  collect_time TIMESTAMP(9) NOT NULL,
  collect_time_utc TIMESTAMP(9) NULL,
  peak_current FLOAT NULL,
  TIME INDEX (collect_time)
)
ENGINE=mito
WITH(
  'compaction.twcs.time_window' = '7d',
  'compaction.type' = 'twcs'
);

Affected Rows: 0

-- insert some data, with collect_time  = collect_time_utc + 8 hour
INSERT INTO lightning VALUES 
  ('2025-03-01 16:00:00', '2025-03-01 08:00:00', 1.0),
  ('2025-03-01 17:00:00', '2025-03-01 09:00:00', 1.0),
  ('2025-03-01 18:00:00', '2025-03-01 10:00:00', 1.0),
  ('2025-03-01 19:00:00', '2025-03-01 11:00:00', 1.0),
  ('2025-03-01 20:00:00', '2025-03-01 12:00:00', 1.0),
  ('2025-03-01 21:00:00', '2025-03-01 13:00:00', 1.0),
  ('2025-03-01 22:00:00', '2025-03-01 14:00:00', 1.0),
  ('2025-03-01 23:00:00', '2025-03-01 15:00:00', 1.0)
;

Affected Rows: 8

-- notice the alias make order by not applicable for window sort
SELECT
  collect_time_utc AS collect_time,
  peak_current,
FROM
  lightning
ORDER BY
  collect_time ASC;

+---------------------+--------------+
| collect_time        | peak_current |
+---------------------+--------------+
| 2025-03-01T08:00:00 | 1.0          |
| 2025-03-01T09:00:00 | 1.0          |
| 2025-03-01T10:00:00 | 1.0          |
| 2025-03-01T11:00:00 | 1.0          |
| 2025-03-01T12:00:00 | 1.0          |
| 2025-03-01T13:00:00 | 1.0          |
| 2025-03-01T14:00:00 | 1.0          |
| 2025-03-01T15:00:00 | 1.0          |
+---------------------+--------------+

-- SQLNESS REPLACE (-+) -
-- SQLNESS REPLACE (\s\s+) _
-- SQLNESS REPLACE (peers.*) REDACTED
-- SQLNESS REPLACE (metrics.*) REDACTED
-- SQLNESS REPLACE region=\d+\(\d+,\s+\d+\) region=REDACTED
EXPLAIN ANALYZE SELECT
  collect_time_utc AS collect_time,
  peak_current,
FROM
  lightning
ORDER BY
  collect_time ASC;

+-+-+-+
| stage | node | plan_|
+-+-+-+
| 0_| 0_|_MergeScanExec: REDACTED
|_|_|_|
| 1_| 0_|_ProjectionExec: expr=[collect_time_utc@0 as collect_time, peak_current@1 as peak_current] REDACTED
|_|_|_SortExec: expr=[collect_time_utc@0 ASC NULLS LAST], preserve_partitioning=[false] REDACTED
|_|_|_SeqScan: region=REDACTED, partition_count=1 (1 memtable ranges, 0 file 0 ranges) REDACTED
|_|_|_|
|_|_| Total rows: 8_|
+-+-+-+

DROP TABLE lightning;

Affected Rows: 0

