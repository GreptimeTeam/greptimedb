create table data (ts timestamp(3) time index, val double);

Affected Rows: 0

insert into data values (0, 1), (10000, 2), (20000, 3);

Affected Rows: 3

tql eval (0, 30, '10s'), data < 1;

++
++

tql eval (0, 30, '10s'), data + (1 < bool 2);

+---------------------+-------------------------------+
| ts                  | val + Float64(1) < Float64(2) |
+---------------------+-------------------------------+
| 1970-01-01T00:00:00 | 2.0                           |
| 1970-01-01T00:00:10 | 3.0                           |
| 1970-01-01T00:00:20 | 4.0                           |
| 1970-01-01T00:00:30 | 4.0                           |
+---------------------+-------------------------------+

tql eval (0, 30, '10s'), data + (1 > bool 2);

+---------------------+-------------------------------+
| ts                  | val + Float64(1) > Float64(2) |
+---------------------+-------------------------------+
| 1970-01-01T00:00:00 | 1.0                           |
| 1970-01-01T00:00:10 | 2.0                           |
| 1970-01-01T00:00:20 | 3.0                           |
| 1970-01-01T00:00:30 | 3.0                           |
+---------------------+-------------------------------+

drop table data;

Affected Rows: 0

-- Binary operator on table with multiple field columns
create table data (ts timestamp time index, val1 double, val2 double, val3 double);

Affected Rows: 0

insert into data values (0, 1, 100, 10000), (10000, 2, 200, 20000), (20000, 3, 300, 30000);

Affected Rows: 3

-- SQLNESS SORT_RESULT 3 1
tql eval (0, 30, '10s'), data / data;

+---------------------+---------------------+---------------------+---------------------+
| ts                  | lhs.val1 / rhs.val1 | lhs.val2 / rhs.val2 | lhs.val3 / rhs.val3 |
+---------------------+---------------------+---------------------+---------------------+
| 1970-01-01T00:00:00 | 1.0                 | 1.0                 | 1.0                 |
| 1970-01-01T00:00:10 | 1.0                 | 1.0                 | 1.0                 |
| 1970-01-01T00:00:20 | 1.0                 | 1.0                 | 1.0                 |
| 1970-01-01T00:00:30 | 1.0                 | 1.0                 | 1.0                 |
+---------------------+---------------------+---------------------+---------------------+

-- SQLNESS SORT_RESULT 3 1
tql eval (0, 30, '10s'), data{__field__="val1"} + data{__field__="val2"};

+---------------------+---------------------+
| ts                  | lhs.val1 + rhs.val2 |
+---------------------+---------------------+
| 1970-01-01T00:00:00 | 101.0               |
| 1970-01-01T00:00:10 | 202.0               |
| 1970-01-01T00:00:20 | 303.0               |
| 1970-01-01T00:00:30 | 303.0               |
+---------------------+---------------------+

-- SQLNESS SORT_RESULT 3 1
tql eval (0, 30, '10s'), data{__field__="val1", __field__="val2"} + data{__field__="val2", __field__="val3"};

+---------------------+---------------------+---------------------+
| ts                  | lhs.val1 + rhs.val2 | lhs.val2 + rhs.val3 |
+---------------------+---------------------+---------------------+
| 1970-01-01T00:00:00 | 101.0               | 10100.0             |
| 1970-01-01T00:00:10 | 202.0               | 20200.0             |
| 1970-01-01T00:00:20 | 303.0               | 30300.0             |
| 1970-01-01T00:00:30 | 303.0               | 30300.0             |
+---------------------+---------------------+---------------------+

drop table data;

Affected Rows: 0

create table host_cpu_seconds_total (
    ts timestamp time index,
    val double,
    host string,
    `mode` string,
    primary key (host, `mode`)
);

Affected Rows: 0

insert into host_cpu_seconds_total values
    (0, 0.1, 'host1', 'idle'),
    (0, 0.2, 'host1', 'user'),
    (0, 0.3, 'host1', 'system'),
    (10000, 0.4, 'host1', 'idle'),
    (10000, 0.5, 'host1', 'user'),
    (10000, 0.6, 'host1', 'system'),
    (20000, 0.2, 'host1', 'idle'),
    (20000, 0.3, 'host1', 'user'),
    (20000, 0.4, 'host1', 'system'),
    (30000, 0.5, 'host1', 'idle'),
    (30000, 0.6, 'host1', 'user'),
    (30000, 0.7, 'host1', 'system');

Affected Rows: 12

-- SQLNESS SORT_RESULT 3 1
tql eval (0, 30, '10s') (sum by(host) (irate(host_cpu_seconds_total{mode!="idle"}[1m0s])) / sum by (host)((irate(host_cpu_seconds_total[1m0s])))) * 100;

+-------+---------------------+--------------------------------------------------------------------------------------+
| host  | ts                  | lhs.SUM(prom_irate(ts_range,val)) / rhs.SUM(prom_irate(ts_range,val)) * Float64(100) |
+-------+---------------------+--------------------------------------------------------------------------------------+
| host1 | 1970-01-01T00:00:10 | 66.66666666666666                                                                    |
| host1 | 1970-01-01T00:00:20 | 77.77777777777779                                                                    |
| host1 | 1970-01-01T00:00:30 | 66.66666666666666                                                                    |
+-------+---------------------+--------------------------------------------------------------------------------------+

drop table host_cpu_seconds_total;

Affected Rows: 0

