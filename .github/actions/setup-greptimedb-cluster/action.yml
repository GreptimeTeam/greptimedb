name: Setup GreptimeDB cluster
description: Deploy GreptimeDB cluster on Kubernetes
inputs:
  frontend-replica-count:
    default: 1
    description: "Frontend replica count"
  datanode-replica-count:
    default: 2
    description: "Datanode replica count"
  metasrv-replica-count:
    default: 1
    description: "Metasrv replica count"
  etcd-replica-count:
    default: 1
    description: "Etcd replica count"
  image-registry: 
    default: "docker.io"
    description: "Image registry"
  image-repository: 
    default: "greptime/greptimedb"
    description: "Image repository"
  image-tag: 
    default: "latest"
    description: 'Image tag'

runs:
  using: composite
  steps:
  - name: Install greptime operator
    shell: bash
    run: |
      helm repo add greptime https://greptimeteam.github.io/helm-charts/ 
      helm repo update
      helm upgrade \
        --install \
        --create-namespace \
        greptimedb-operator greptime/greptimedb-operator \
        -n greptimedb-admin
  - name: Install etcd cluster
    shell: bash
    run: | 
      helm upgrade \
        --install etcd oci://registry-1.docker.io/bitnamicharts/etcd \
        --set replicaCount=${{ inputs.etcd-replica-count }} \
        --set auth.rbac.create=false \
        --set auth.rbac.token.enabled=false \
        --set persistence.size=1Gi \
        --create-namespace \
        -n etcd-cluster
  - name: Wait for etcd
    shell: bash
    run: |
      kubectl wait \
        --for=condition=Ready \
        pod -l app.kubernetes.io/instance=etcd \
        --timeout=120s \
        -n etcd-cluster
  - name: Print etcd info
    shell: bash
    run: kubectl get all --show-labels -n etcd-cluster
  - name: Install GreptimeDB cluster
    shell: bash
    run: | 
      helm upgrade \
        --install my-greptimedb \
        --set meta.etcdEndpoints=etcd.etcd-cluster.svc.cluster.local:2379 \
        --set image.registry=${{ inputs.image-registry }} \
        --set image.repository=${{ inputs.image-repository }}  \
        --set image.tag=${{ inputs.image-tag }} \
        greptime/greptimedb-cluster \
        --create-namespace \
        -n my-greptimedb
  - name: Wait for GreptimeDB
    shell: bash
    run: |
      kubectl wait \
        --for=condition=Ready \
        pod -l app.greptime.io/component=my-greptimedb-meta \
        --timeout=120s \
        -n my-greptimedb
      kubectl wait \
        --for=condition=Ready \
        pod -l app.greptime.io/component=my-greptimedb-datanode \
        --timeout=120s \
        -n my-greptimedb
      kubectl wait \
        --for=condition=Ready \
        pod -l app.greptime.io/component=my-greptimedb-frontend \
        --timeout=120s \
        -n my-greptimedb
  - name: Print GreptimeDB info
    if: always()
    shell: bash
    run: | 
      kubectl get all --show-labels -n my-greptimedb
  - name: Export kind logs
    if: failure()
    shell: bash
    run: | 
      kind export logs /tmp/kind
  - name: Upload logs
    if: failure()
    uses: actions/upload-artifact@v4
    with:
      name: kind-logs
      path: /tmp/kind
      retention-days: 3