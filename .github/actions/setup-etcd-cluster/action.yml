name: Setup Etcd cluster
description: Deploy Etcd cluster on Kubernetes
inputs:
  etcd-replicas:
    default: 1
    description: "Etcd replicas"
  namespace:
    default: "etcd-cluster"

runs:
  using: composite
  steps:
  - name: Install Etcd cluster
    shell: bash
    run: |
      helm upgrade \
        --install etcd oci://registry-1.docker.io/bitnamicharts/etcd \
        --set replicaCount=${{ inputs.etcd-replicas }} \
        --set resources.requests.cpu=50m \
        --set resources.requests.memory=128Mi \
        --set resources.limits.cpu=1500m \
        --set resources.limits.memory=2Gi \
        --set auth.rbac.create=false \
        --set auth.rbac.token.enabled=false \
        --set persistence.size=2Gi \
        --create-namespace \
        --set global.security.allowInsecureImages=true \
        --set image.registry=docker.io \
        --set image.repository=greptime/etcd \
        --set image.tag=3.6.1-debian-12-r3 \
        --version 12.0.8 \
        -n ${{ inputs.namespace }}
